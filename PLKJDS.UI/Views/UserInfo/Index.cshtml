@{
    Layout = "~/Views/Shared/_User.cshtml";
    ViewBag.Title = "我的资料-跨境电商产学研平台";
}
<meta id="pageLabel" data-page="UserInfo" />
<link href="~/Content/css/lq.datetimepick.css" rel="stylesheet" />
<style>
    body {
        background-color: #eee;
        height: 100%;
    }
</style>


<!--右侧正文-->
<div class="col-md-9">
    <div class="rightContent">
        <div class="myCourseNav">
            <div>
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#home" aria-controls="home" role="tab" data-toggle="tab">个人信息</a></li>
                    <li role="presentation"><a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">更换头像</a></li>
                    <li role="presentation"><a href="#messages" aria-controls="messages" role="tab" data-toggle="tab">修改密码</a></li>
                </ul>
                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="home">
                        <!--个人信息-->
                        <div class="height30"></div>
                        <form class="form-horizontal">
                            <div class="form-group">
                                <label for="name" class="col-sm-2 control-label">姓名</label>
                                <div class="col-md-6">
                                    <input type="text" readonly='readonly' class="form-control" id="name" value="" placeholder="">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="stuNo" class="col-sm-2 control-label">学号</label>
                                <div class="col-md-6">
                                    <input type="text" readonly='readonly' class="form-control" id="stuNo" value="" placeholder="">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="school" class="col-sm-2 control-label">所属院校</label>
                                <div class="col-md-6">
                                    <input type="text" readonly='readonly' class="form-control" id="school" value="" placeholder="">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="pastern" class="col-sm-2 control-label">所在系别</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="pastern" value="" placeholder="请填写所在系部">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">性别</label>
                                <div class="col-md-6">
                                    <select class="form-control" id="sex">
                                        <option>请选择性别</option>
                                        <option value="0">男</option>
                                        <option value="1">女</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="birthday" class="col-sm-2 control-label">生日</label>
                                <div class="col-md-6">
                                    <input type="text" name="birthday" id="birthday" class="form-control" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="phone" class="col-sm-2 control-label">手机号码</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="phone" placeholder="请输入手机号码">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="email" class="col-sm-2 control-label">邮箱</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="email" placeholder="请输入邮箱">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">通讯地址</label>
                                <div class="col-md-6 form-inline">
                                    <div class="form-group">
                                        <select class="form-control" id="cmbProvince" style="margin-left: 16px;width: 121px"></select>
                                    </div>
                                    <div class="form-group">
                                        <select class="form-control" id="cmbCity" style="margin-left: 36px;width: 121px"></select>
                                    </div>
                                    <div class="form-group">
                                        <select class="form-control" id="cmbArea" style="margin-left: 36px;width: 121px"></select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group" style="text-align: center">
                                <div class="height30"></div>
                                <div class="col-md-9">
                                    <button type="button" class="btn btn-primary confirmButton" onclick="modifyUserInfo()">保存</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="profile">
                        <!--更换头像-->
                        <div class="height30"></div>
                        <div class="height30"></div>
                        <div class="text-center">
                            <div class="avatarBox">
                                <img id="avatar" src="img/images/plus.jpg" width="100%" height="auto" alt="">
                            </div>
                            <div class="height20"></div>
                            <div>
                                <a href="javascript:;" class="file">
                                    上传头像
                                    <input type="file" name="" id="file" onchange="coverUpload()">
                                </a>
                                <input type="text" id="cover" class="hidden">
                                <button type="button" class="btn btn-primary confirmButton2" onclick="modifyUserLogo()">保存</button>
                            </div>
                            <div class="height30"></div>
                        </div>

                    </div>
                    <div role="tabpanel" class="tab-pane" id="messages" style="text-align: center">
                        <!--修改密码-->
                        <div class="height30"></div>
                        <form class="form-horizontal" style="margin: 0 auto">
                            <div class="form-group">
                                <label for="oldPassword" class="col-sm-2 control-label">旧密码</label>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="oldPassword" placeholder="">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="newPassword" class="col-sm-2 control-label">新密码</label>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="newPassword" placeholder="">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="rePassword" class="col-sm-2 control-label">确认密码</label>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="rePassword" placeholder="">
                                </div>
                            </div>
                            <div class="form-group" style="text-align: center">
                                <div class="height30"></div>
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-primary confirmButton" onclick="modifyUserPwd()">保存</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="height30"></div>
        <div class="height30"></div>
        <div class="height30"></div>
    </div>
</div>

<script src="~/Content/js/yifanToast.js"></script>
<!--独有js-->
<script src="~/Content/js/jsAddress.js"></script>
<script src='~/Content/js/selectUi.js' type='text/javascript'></script>
<script src='~/Content/js/lq.datetimepick.js' type='text/javascript'></script>
<script>
    function ct() {
        return document.compatMode == "BackCompat" ? document.body.clientHeight : document.documentElement.clientHeight;
    }

    $(function () {
        (window.onresize = function () {
            var f = document.getElementById('footer');
            f.style.position = document.body.scrollHeight > ct() ? '' : 'absolute';
        })();
        $("#birthday").on("click", function (e) {
            e.stopPropagation();
            $(this).lqdatetimepicker({
                css: 'datetime-day',
                dateType: 'D',
                selectback: function () {

                }
            });
        });
    });

    //addressInit('cmbProvince', 'cmbCity', 'cmbArea');

    var modifyUserInfoUrl = '@Url.Action("ModifyUserInfo", "UserInfo")';
    //修改用户信息
    function modifyUserInfo() {
        //var name = $('#name').val();
        //var stuNo = $('#stuNo').val();
        //var school = $('#school').val();
        var pastern = $('#pastern').val();
        var sex = $('#sex').val();
        var birthday = $('#birthday').val();
        var phone = $('#phone').val();
        var email = $('#email').val();
        var province = $('#cmbProvince').val();
        var city = $('#cmbCity').val();
        var area = $('#cmbArea').val();
        //var logo = $('#cover').val();
        var data = {
            pastern:pastern,
            sex:sex,
            birthday:birthday,
            phone:phone,
            email:email,
            province:province,
            city:city,
            area:area
        };
        $.ajax({
            type: "POST",
            url: modifyUserInfoUrl,//填写保存用户基本信息接口
            dataType: "json",
            contentType: 'application/x-www-form-urlencoded;charset=UTF-8',
            cache: false,
            data: data,
            success: function (data) {
                if (data.state == "success") {
                    yifanToast("保存成功！", 'toast-md');
                } else {
                    yifanToast("保存失败，请重试", 'toast-md');
                }
            },
            error: function () {
                yifanToast("无法连接服务器", 'toast-md');
            }
        });
    }

    //照片异步上传，后端写好图片处理逻辑，并且返回成功状态码10000和正确的url地址
    var coverUploadUrl = "@Url.Action("UploadFile", "File")";
    function coverUpload() {
        debugger;
        var form_data = new FormData();
        var file = $("#file").prop("files")[0];
        if (!file) {
            return;
        }
        form_data.append("file", file);
        $.ajax({
            type: "POST",
            url: coverUploadUrl,
            dataType: "json",
            processData: false,
            contentType: false,
            data: form_data,
            success: function (data) {
                if (data.state == "success") {
                    //$("#cover").val(data.src);
                    $("#avatar").attr("src", data.data.url);
                    $('#cover').val(data.data.id);
                } else {
                    yifanToast("上传图片错误，请重试", 'toast-md');
                }
            },
            error: function () {
                yifanToast("无法连接服务器", 'toast-md');
            }
        })
    }

    var modifyUserLogoUrl = '@Url.Action("ModifyUserLogo", "UserInfo")';
    //修改用户头像
    function modifyUserLogo() {
        var logo = $('#cover').val();
        var data = {
            logo: logo
        };
        $.ajax({
            type: "POST",
            url: modifyUserLogoUrl,//填写保存用户基本信息接口
            dataType: "json",
            contentType: 'application/x-www-form-urlencoded;charset=UTF-8',
            cache: false,
            data: data,
            success: function (data) {
                if (data.state == "success") {
                    yifanToast("保存成功！", 'toast-md');
                } else {
                    yifanToast("保存失败，请重试", 'toast-md');
                }
            },
            error: function () {
                yifanToast("无法连接服务器", 'toast-md');
            }
        });
    }
    var modifyUserPwdUrl = '@Url.Action("ModifyUserPwd", "UserInfo")';
    //修改用户密码
    function modifyUserPwd() {
        //oldPassword，newPassword，rePassword
        var data = {
            oldPwd: $("#oldPassword").val(),
            newPwd: $('#newPassword').val(),
            rePwd: $('#rePassword').val()
        };
        if ($.trim(data.oldPwd) == "") {
            yifanToast("旧密码必填！", 'toast-md');
            return;
        }
        if ($.trim(data.newPwd) == "") {
            yifanToast("新密码必填！", 'toast-md');
            return;
        }
        if (data.oldPwd == data.newPwd) {
            yifanToast("旧密码与新密码不能相同！", 'toast-md');
            return;
        }
        if ($.trim(data.rePwd) == "") {
            yifanToast("确认密码必填！", 'toast-md');
            return;
        }
        if (data.newPwd != data.rePwd) {
            yifanToast("两次新密码不同，请重新输入！", 'toast-md');
            return;
        }
        
        data.oldPwd = $.md5(data.oldPwd);
        data.newPwd = $.md5(data.newPwd);
        data.rePwd = $.md5(data.rePwd);

        $.ajax({
            type: "POST",
            url: modifyUserPwdUrl,//填写保存用户基本信息接口
            dataType: "json",
            contentType: 'application/x-www-form-urlencoded;charset=UTF-8',
            cache: false,
            data: data,
            success: function (data) {
                if (data.state == "success") {
                    yifanToast("修改成功！", 'toast-md');
                } else {
                    //yifanToast("修改失败，请重试", 'toast-md');
                    yifanToast("修改失败，" + data.message, 'toast-md');
                }
            },
            error: function () {
                yifanToast("无法连接服务器", 'toast-md');
            }
        });
    }

    //加载用户信息
    function loadUserInfo(ui) {
        //name，stuNo， school， pastern，sex，birthday，phone，email，（province，city，area）
        $('#name').val(ui.name);
        $('#stuNo').val(ui.stuNo);
        $('#school').val(ui.school);
        $('#pastern').val(ui.pastern);
        $('#sex').val(ui.sex);
        $('#birthday').val(ui.birthday);
        $('#phone').val(ui.phone);
        $('#email').val(ui.email);
        //$('#cmbProvince').val(ui.province);
        //$('#cmbCity').val(ui.city);
        //$('#cmbArea').val(ui.area);

        addressInit('cmbProvince', 'cmbCity', 'cmbArea', ui.province, ui.city, ui.area);

        $('#cover').val(ui.logo);
        $('#avatar').attr('src', "/File/GetFile?keyValue=" + ui.logo);
    }

    //用户信息
    var userInfo = '@Html.Raw(ViewBag.UserInfo)';
    $(function () {
        if (userInfo) {
            try {
                var ui = JSON.parse(userInfo);
                loadUserInfo(ui);
            } catch (e) {

            }
        }
    });

</script>